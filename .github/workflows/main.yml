name: Build APK from Project

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract Android Project
      run: |
        echo "=== Extracting project ZIP ==="
        
        # فك ضغط المشروع
        if [ -f "Dashboard_AndroidProject.zip" ]; then
          unzip -q Dashboard_AndroidProject.zip -d project
          echo "ZIP extracted to project/"
        else
          # إذا كان هناك أي ملف ZIP
          for zip in *.zip; do
            if [ -f "$zip" ]; then
              unzip -q "$zip" -d project
              echo "Extracted $zip"
              break
            fi
          done
        fi
        
        # نسخ محتويات المشروع إلى الدليل الرئيسي
        echo "=== Copying project files ==="
        cp -r project/* . 2>/dev/null || cp -r project/. . 2>/dev/null || true
        
        echo "=== Current files ==="
        ls -la
        echo ""
        echo "=== Looking for Android files ==="
        find . -name "*.gradle" -o -name "AndroidManifest.xml" | head -10
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Prepare Android Project
      run: |
        echo "=== Preparing Android project ==="
        
        # تأكد من وجود مجلد app
        if [ ! -d "app" ]; then
          echo "ERROR: No 'app' directory found!"
          echo "Available directories:"
          find . -type d -maxdepth 2 | head -20
          exit 1
        fi
        
        # تأكد من وجود build.gradle
        if [ ! -f "app/build.gradle" ] && [ ! -f "build.gradle" ]; then
          echo "WARNING: No build.gradle found, creating basic one..."
          
          # ابحث عن أي build.gradle في أي مكان
          FOUND_GRADLE=$(find . -name "build.gradle" -type f | head -1)
          if [ -n "$FOUND_GRADLE" ]; then
            echo "Found build.gradle at: $FOUND_GRADLE"
            cp "$FOUND_GRADLE" app/build.gradle 2>/dev/null || true
          else
            # أنشئ build.gradle أساسي
            cat > app/build.gradle << 'EOF'
            plugins {
                id 'com.android.application'
            }
            
            android {
                compileSdk 34
                
                defaultConfig {
                    applicationId "com.example.app"
                    minSdk 21
                    targetSdk 34
                    versionCode 1
                    versionName "1.0"
                }
                
                buildTypes {
                    debug {
                        debuggable true
                    }
                }
            }
            
            dependencies {
                implementation 'androidx.appcompat:appcompat:1.6.1'
            }
            EOF
          fi
        fi
        
        # أنشئ ملفات Gradle الأساسية إذا لم تكن موجودة
        if [ ! -f "settings.gradle" ]; then
          echo "include ':app'" > settings.gradle
        fi
        
        if [ ! -f "build.gradle" ]; then
          cat > build.gradle << 'EOF'
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.1.0'
              }
          }
          
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF
        fi
        
        # أنشئ gradlew إذا لم يكن موجوداً
        if [ ! -f "gradlew" ]; then
          echo "=== Creating Gradle wrapper ==="
          gradle wrapper --gradle-version 8.5
          chmod +x gradlew
        fi
        
    - name: Build Android APK
      run: |
        echo "=== Building APK ==="
        
        # حاول البناء
        if [ -f "gradlew" ]; then
          ./gradlew :app:assembleDebug --stacktrace --info
        else
          gradle :app:assembleDebug --stacktrace --info
        fi
        
    - name: Find and Upload APK
      run: |
        echo "=== Searching for APK ==="
        find . -name "*.apk" -type f 2>/dev/null
        
      # تحميل الـ APK
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-application
        path: |
          app/build/outputs/apk/**/*.apk
          **/build/outputs/apk/**/*.apk
          **/*.apk
        if-no-files-found: error
