name: Build Android APK - From ZIP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Extract Android Project
      run: |
        echo "=== Extracting ZIP file ==="
        ls -la *.zip || echo "No ZIP files found"
        
        # فك ضغط المشروع
        unzip -q Dashboard_AndroidProject.zip -d extracted_project || \
        unzip -q *.zip -d extracted_project || \
        echo "No ZIP file to extract"
        
        # نسخ المحتوى إذا كان هناك مجلد
        if [ -d "extracted_project" ]; then
          echo "=== Copying extracted content ==="
          cp -r extracted_project/* . || cp -r extracted_project/. . || true
          ls -la
        fi
        
    - name: Setup Android
      uses: android-actions/setup-android@v3
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Prepare Gradle
      run: |
        echo "=== Project structure after extraction ==="
        find . -maxdepth 3 -type f -name "*.gradle" -o -name "*.xml" | head -20
        
        # إذا كان هناك gradlew، اجعله قابل للتنفيذ
        if [ -f "gradlew" ]; then
          chmod +x gradlew
        fi
        
    - name: Build APK
      run: |
        # حاول البناء بأي طريقة
        if [ -f "gradlew" ]; then
          ./gradlew assembleDebug --stacktrace
        elif [ -f "app/build.gradle" ]; then
          gradle assembleDebug --stacktrace
        else
          echo "ERROR: No build files found!"
          exit 1
        fi
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: |
          app/build/outputs/apk/**/*.apk
          **/build/outputs/apk/**/*.apk
          build/**/*.apk
          *.apk
        if-no-files-found: error
